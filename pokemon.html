<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>Neural ProDex - PC Storage</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Rajdhani:wght@500;700&display=swap');
        body { background: #020617; color: white; font-family: 'Rajdhani', sans-serif; }
        .ranch-card { background: rgba(30, 41, 59, 0.5); border: 1px solid rgba(255,255,255,0.1); border-radius: 15px; padding: 20px; margin-bottom: 30px; }
        .pkmn-mini-card { background: #0f172a; border-left: 3px solid #0ea5e9; padding: 10px; border-radius: 8px; transition: all 0.2s; }
        .pkmn-mini-card:hover { transform: translateY(-3px); background: #1e293b; }
        .label-tech { font-family: 'Orbitron'; font-size: 0.7rem; color: #0ea5e9; text-transform: uppercase; }
        .natura-badge { background: #fbbf24; color: black; font-size: 0.6rem; padding: 2px 6px; border-radius: 4px; font-weight: bold; }
    </style>
</head>
<body class="p-6">

    <div class="max-w-6xl mx-auto">
        <header class="flex justify-between items-center mb-10 border-b border-white/10 pb-6">
            <h1 class="text-3xl font-black font-[Orbitron] italic uppercase">Neural <span class="text-red-600">Storage</span></h1>
            <a href="index.html" class="bg-white/5 px-4 py-2 rounded-xl text-xs font-bold border border-white/10 hover:bg-white/20">Torna all'Hub</a>
        </header>

        <div id="storage-container">
            <div class="text-center animate-pulse text-slate-500">Sincronizzazione con il server in corso...</div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyA7Xb8BbyL9s7buH_BW0hx2exD5Tb5G-pk",
            authDomain: "pokerole-app.firebaseapp.com",
            projectId: "pokerole-app",
            storageBucket: "pokerole-app.firebasestorage.app",
            messagingSenderId: "385416519668",
            appId: "1:385416519668:web:908e12b9833f1cdc04a3a1"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                loadStorage(user.uid);
            } else {
                window.location.href = 'index.html';
            }
        });

        async function loadStorage(uid) {
            const container = document.getElementById('storage-container');
            
            try {
                const userSnap = await getDoc(doc(db, "Users", uid));
                if (!userSnap.exists()) return container.innerHTML = "Nessun dato trovato.";

                const data = userSnap.data();
                let html = "";

                // --- 1. SEZIONE RANCH ALLENATORI ---
                html += `<h2 class="label-tech text-xl mb-6 text-yellow-500">üèòÔ∏è Ranch Allenatori (Sincronizzati)</h2>`;
                const allenatori = data.allenatori_generati || [];
                
                if (allenatori.length === 0) {
                    html += `<p class="text-slate-500 mb-10 italic">Nessun allenatore attivo registrato.</p>`;
                } else {
                    allenatori.forEach(all => {
                        html += `
                        <div class="ranch-card">
                            <div class="flex justify-between items-center mb-4 border-b border-white/5 pb-2">
                                <span class="label-tech text-white text-lg">${all.name.toUpperCase()}</span>
                                <span class="text-[10px] text-slate-400">TEAM CAPACITY: ${(all.team ? all.team.length : 0)}/6</span>
                            </div>
                            <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4">
                                ${(all.team && all.team.length > 0) ? all.team.map(pk => `
                                    <div class="pkmn-mini-card">
                                        <img src="${pk.immagine || pk.image}" class="w-full h-20 object-contain mb-2">
                                        <div class="text-[11px] font-bold uppercase truncate">${pk.nome || pk.name}</div>
                                        <div class="text-[9px] text-cyan-400">LV.${pk.level || pk.hp}</div>
                                    </div>
                                `).join('') : '<p class="col-span-full text-xs text-slate-600">Questo allenatore non ha Pok√©mon nel team.</p>'}
                            </div>
                        </div>`;
                    });
                }

                // --- 2. SEZIONE POKEMON SELVATICI (PER NATURA/TIPO) ---
                html += `<h2 class="label-tech text-xl mt-12 mb-6 text-emerald-500">üåø Riserva Naturale (Pok√©mon Selvatici)</h2>`;
                const selvatici = data.pokemon_salvati || [];

                if (selvatici.length === 0) {
                    html += `<p class="text-slate-500 italic">La riserva √® vuota. Cattura Pok√©mon nello Scanner!</p>`;
                } else {
                    // Raggruppamento per Tipo (visto che la "Natura" √® un parametro casuale del manuale)
                    const grouped = selvatici.reduce((acc, pk) => {
                        const key = pk.tipo ? pk.tipo[0] : "Ignoto";
                        if (!acc[key]) acc[key] = [];
                        acc[key].push(pk);
                        return acc;
                    }, {});

                    Object.entries(grouped).forEach(([tipo, pks]) => {
                        html += `
                        <div class="mb-8">
                            <h3 class="text-xs font-black uppercase tracking-widest text-slate-400 mb-4 flex items-center gap-2">
                                <span class="w-2 h-2 rounded-full bg-emerald-500"></span> Habitat ${tipo} (${pks.length})
                            </h3>
                            <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4">
                                ${pks.map(pk => `
                                    <div class="pkmn-mini-card !border-l-emerald-500">
                                        <img src="${pk.immagine || pk.image}" class="w-full h-20 object-contain mb-2">
                                        <div class="text-[11px] font-bold uppercase truncate">${pk.nome || pk.name}</div>
                                        <span class="natura-badge">${pk.rango || 'WILD'}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>`;
                    });
                }

                container.innerHTML = html;

            } catch (e) {
                console.error(e);
                container.innerHTML = "Errore durante il caricamento dei dati.";
            }
        }
    </script>
</body>
</html>
