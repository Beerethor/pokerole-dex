<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Neural ProDex - Trainer Management</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;900&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root { --pokedex-red: #ef4444; --bg-dark: #020617; --neon-blue: #0ea5e9; }
        body { background-color: var(--bg-dark); font-family: 'JetBrains Mono', monospace; color: white; }
        
        .trainer-sheet { 
            background: #e2e8f0; color: #1e293b; border-radius: 20px; 
            padding: 20px; border: 4px solid #94a3b8; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        .header-card { background: #ef4444; color: white; border-radius: 15px 15px 0 0; padding: 10px; font-family: 'Orbitron'; }
        
        .stat-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
        .stat-box { background: #cbd5e1; padding: 5px 10px; border-radius: 8px; border-bottom: 2px solid #94a3b8; }
        .label-sm { font-size: 0.6rem; font-weight: 800; text-transform: uppercase; color: #475569; }
        
        input, select, textarea { 
            background: white; border: 1px solid #94a3b8; border-radius: 4px; 
            padding: 2px 5px; width: 100%; color: #1e293b; font-weight: bold;
        }

        .dot-input { width: 12px; height: 12px; cursor: pointer; accent-color: #ef4444; }
        
        /* Stile Pips Statistici */
        .pips-container { display: flex; gap: 2px; }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-6xl mx-auto">
        <header class="flex justify-between items-center mb-10 border-b border-white/10 pb-6">
            <div>
                <h1 class="text-4xl font-black font-[Orbitron] italic uppercase">Gestione <span class="text-red-500">Allenatori</span></h1>
                <p class="text-[10px] text-slate-500 uppercase tracking-widest">Protocollo Pokerole 2.0</p>
            </div>
            <div class="flex gap-4">
                <button onclick="showNewTrainerForm()" class="bg-blue-600 hover:bg-blue-500 px-6 py-2 rounded-xl font-black uppercase text-xs">Nuovo Operatore</button>
                <a href="index.html" class="bg-white/5 border border-white/10 px-6 py-2 rounded-xl text-xs font-black uppercase hover:bg-white/10">Hub</a>
            </div>
        </header>

        <div id="trainer-form" class="hidden mb-12 bg-slate-900/50 p-8 rounded-3xl border border-white/10">
            <h2 class="text-xl font-black mb-6 uppercase text-blue-400">Registrazione Nuova Matrice</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                <div class="space-y-4 text-center">
                    <div class="relative w-48 h-48 mx-auto bg-slate-800 rounded-2xl border-2 border-dashed border-slate-600 flex items-center justify-center overflow-hidden group">
                        <img id="preview-img" class="absolute inset-0 w-full h-full object-cover hidden">
                        <span class="text-[10px] uppercase font-bold text-slate-500 group-hover:text-white transition-colors">Carica Foto</span>
                        <input type="file" id="t-file" onchange="previewFile()" class="absolute inset-0 opacity-0 cursor-pointer">
                    </div>
                    <input type="text" id="t-name" placeholder="NOME ALLENATORE [cite: 7]" class="!bg-slate-800 !text-white !border-slate-700">
                    <input type="number" id="t-age" placeholder="ETÀ [cite: 8]" class="!bg-slate-800 !text-white !border-slate-700">
                </div>

                <div class="space-y-2">
                    <label class="label-sm text-slate-400">Concept & Natura [cite: 10, 11]</label>
                    <input type="text" id="t-concept" placeholder="Es: Giramondo">
                    <input type="text" id="t-nature" placeholder="Es: Audace">
                    <label class="label-sm text-slate-400">Rango [cite: 6]</label>
                    <select id="t-rank">
                        <option value="Starter">Starter</option>
                        <option value="Beginner">Beginner</option>
                        <option value="Amateur">Amateur</option>
                        <option value="Ace">Ace</option>
                        <option value="Pro">Pro</option>
                        <option value="Master">Master</option>
                    </select>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="label-sm">Strength [cite: 23]</label>
                        <input type="number" id="s-str" value="1" max="5">
                        <label class="label-sm">Dexterity [cite: 27]</label>
                        <input type="number" id="s-dex" value="1" max="5">
                        <label class="label-sm">Vitality [cite: 30]</label>
                        <input type="number" id="s-vit" value="1" max="5">
                    </div>
                    <div>
                        <label class="label-sm">Insight [cite: 33]</label>
                        <input type="number" id="s-ins" value="1" max="5">
                        <label class="label-sm">HP [cite: 1]</label>
                        <input type="number" id="s-hp" value="4">
                        <label class="label-sm">Will [cite: 2]</label>
                        <input type="number" id="s-will" value="3">
                    </div>
                </div>
            </div>
            <button onclick="saveTrainer()" class="w-full mt-8 bg-green-600 py-4 rounded-xl font-black uppercase hover:bg-green-500">Salva nel Database Cloud</button>
        </div>

        <div id="trainer-list" class="grid grid-cols-1 lg:grid-cols-2 gap-10">
            </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, updateDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyA7Xb8BbyL9s7buH_BW0hx2exD5Tb5G-pk",
            authDomain: "pokerole-app.firebaseapp.com",
            projectId: "pokerole-app",
            storageBucket: "pokerole-app.firebasestorage.app",
            messagingSenderId: "385416519668",
            appId: "1:385416519668:web:908e12b9833f1cdc04a3a1"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;
        let base64Image = null;

        // ESPONGO LE FUNZIONI AL WINDOW PER I TASTI HTML
        window.showNewTrainerForm = () => {
            const form = document.getElementById('trainer-form');
            form.classList.toggle('hidden');
            form.scrollIntoView({ behavior: 'smooth' });
        };

        window.previewFile = () => {
            const file = document.getElementById('t-file').files[0];
            const reader = new FileReader();
            reader.onloadend = () => {
                base64Image = reader.result;
                const img = document.getElementById('preview-img');
                img.src = base64Image;
                img.classList.remove('hidden');
            };
            if (file) reader.readAsDataURL(file);
        };

        window.saveTrainer = async () => {
            if (!currentUser) return alert("Devi essere loggato!");
            
            const name = document.getElementById('t-name').value;
            if(!name) return alert("Inserisci almeno il nome!");

            const btn = document.querySelector('button[onclick="saveTrainer()"]');
            btn.innerText = "SINCRONIZZAZIONE...";
            btn.disabled = true;

            const trainerData = {
                id: Date.now(),
                nome: name,
                eta: document.getElementById('t-age').value || "??",
                rango: document.getElementById('t-rank').value,
                concept: document.getElementById('t-concept').value || "N/A",
                natura: document.getElementById('t-nature').value || "N/A",
                immagine: base64Image || `https://api.dicebear.com/7.x/pixel-art/svg?seed=${name}`,
                stats: {
                    Strength: document.getElementById('s-str').value,
                    Dexterity: document.getElementById('s-dex').value,
                    Vitality: document.getElementById('s-vit').value,
                    Insight: document.getElementById('s-ins').value,
                    HP: document.getElementById('s-hp').value,
                    Will: document.getElementById('s-will').value
                },
                timestamp: new Date().toISOString()
            };

            try {
                const userRef = doc(db, "Users", currentUser.uid);
                await updateDoc(userRef, {
                    allenatori_generati: arrayUnion(trainerData)
                });
                alert("✅ Operatore aggiunto con successo alla squadra!");
                location.reload(); 
            } catch (e) { 
                console.error(e); 
                alert("Errore nel salvataggio.");
            } finally {
                btn.disabled = false;
                btn.innerText = "Salva nel Database Cloud";
            }
        };

        // CARICAMENTO DATI
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                const userDoc = await getDoc(doc(db, "Users", user.uid));
                if (userDoc.exists()) {
                    const data = userDoc.data();
                    if (data.allenatori_generati) {
                        renderTrainers(data.allenatori_generati);
                    }
                }
            } else {
                window.location.href = 'index.html';
            }
        });

        function renderTrainers(list) {
            const container = document.getElementById('trainer-list');
            if (list.length === 0) {
                container.innerHTML = "<p class='col-span-2 text-center text-slate-500 italic'>Nessun operatore registrato. Crea il primo!</p>";
                return;
            }
            
            container.innerHTML = list.sort((a,b) => b.id - a.id).map(t => `
                <div class="trainer-sheet">
                    <div class="header-card flex justify-between items-center px-4">
                        <span class="text-[10px] font-black uppercase tracking-[0.2em]">Pokémon League Card</span>
                        <span class="text-[10px] font-bold bg-white/20 px-2 py-0.5 rounded">RANK: ${t.rango}</span>
                    </div>
                    
                    <div class="grid grid-cols-12 gap-4 mt-4">
                        <div class="col-span-5 space-y-3">
                            <div class="relative group">
                                <img src="${t.immagine}" class="w-full h-44 object-cover rounded-xl border-2 border-slate-400 shadow-lg">
                            </div>
                            <div class="grid grid-cols-2 gap-2">
                                <div class="stat-box text-center">
                                    <span class="label-sm !text-red-700">HP</span>
                                    <div class="font-black text-lg">${t.stats.HP}</div>
                                </div>
                                <div class="stat-box text-center">
                                    <span class="label-sm !text-blue-700">WILL</span>
                                    <div class="font-black text-lg">${t.stats.Will}</div>
                                </div>
                            </div>
                        </div>

                        <div class="col-span-7 space-y-3">
                            <div class="border-b border-slate-400 pb-1">
                                <span class="label-sm">NAME:</span>
                                <div class="text-xl font-black uppercase text-slate-900">${t.nome}</div>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-x-4 gap-y-2">
                                <div><span class="label-sm">Age:</span> <span class="font-bold text-xs">${t.eta}</span></div>
                                <div><span class="label-sm">Nature:</span> <span class="font-bold text-xs">${t.natura}</span></div>
                                <div class="col-span-2"><span class="label-sm">Concept:</span> <span class="font-bold text-xs italic">${t.concept}</span></div>
                            </div>

                            <div class="grid grid-cols-2 gap-2 mt-2">
                                ${Object.entries(t.stats).filter(([k]) => !['HP', 'Will'].includes(k)).map(([key, val]) => `
                                    <div class="bg-slate-300/50 p-1.5 rounded-lg border border-slate-400/30">
                                        <div class="label-sm !text-[7px] mb-1">${key.toUpperCase()}</div>
                                        <div class="flex gap-1">
                                            ${Array.from({length: 5}).map((_, i) => `
                                                <div class="w-2 h-2 rounded-full ${i < val ? 'bg-slate-800' : 'bg-white/50 border border-slate-400'}"></div>
                                            `).join('')}
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }
    </script>
</body>
</html>
