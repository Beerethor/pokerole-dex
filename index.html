<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Neural ProDex - Tactical Hub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root { --pokedex-red: #dc2626; --bg-dark: #020617; --neon-blue: #0ea5e9; }
        
        body { 
            font-family: 'JetBrains Mono', monospace; 
            background: 
                linear-gradient(rgba(2, 6, 23, 0.8), rgba(2, 6, 23, 0.8)), 
                url('img/sfondo_home.png'), #020617; 
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            color: white; 
            min-height: 100vh;
        }

        .glass-card { 
            background: rgba(15, 23, 42, 0.8); 
            backdrop-filter: blur(15px); 
            border: 1px solid rgba(255, 255, 255, 0.1); 
        }

        .btn-auth {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            border: 1px solid #334155;
            cursor: pointer;
            transition: all 0.3s;
        }
        .btn-auth:hover { border-color: var(--neon-blue); box-shadow: 0 0 15px rgba(14, 165, 233, 0.3); }

        .hidden { display: none !important; }
        
        /* Nota password */
        .pwd-note {
            font-size: 9px;
            color: #64748b;
            margin-top: 4px;
            display: block;
            text-align: left;
        }
    </style>
</head>
<body class="flex flex-col items-center justify-center p-6">

    <header class="text-center mb-12">
        <h1 class="text-5xl md:text-7xl font-black italic tracking-tighter uppercase font-[Orbitron] drop-shadow-[0_0_15px_rgba(220,38,38,0.5)]">
            NEURAL <span class="text-red-600">PRODEX</span>
        </h1>
        <p class="text-[9px] text-blue-400 font-bold tracking-[0.6em] uppercase mt-2">Access Control Protocol v3.0</p>
    </header>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 w-full max-w-6xl relative z-10">
        
        <div class="glass-card p-10 rounded-[3rem] flex flex-col justify-center min-h-[450px]">
            <h2 class="text-xs font-black uppercase mb-8 tracking-widest text-red-500 border-b border-white/5 pb-2 italic text-center">Terminal_Auth</h2>
            
            <div id="auth-ui">
                <div class="space-y-4">
                    <div>
                        <input type="email" id="email" placeholder="EMAIL_ID" class="w-full bg-black/60 border border-white/10 rounded-xl p-4 text-sm font-bold outline-none focus:border-red-600 text-white">
                    </div>
                    <div>
                        <input type="password" id="password" placeholder="PASSWORD_HASH" class="w-full bg-black/60 border border-white/10 rounded-xl p-4 text-sm font-bold outline-none focus:border-red-600 text-white">
                        <span class="pwd-note">⚠️ La password deve contenere almeno 6 caratteri.</span>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-3">
                        <button onclick="loginEmail()" class="btn-auth py-3 rounded-xl font-black text-[10px] uppercase tracking-widest">Login</button>
                        <button onclick="registerWithVerification()" class="border border-white/10 py-3 rounded-xl font-black text-[10px] uppercase tracking-widest hover:bg-white hover:text-black transition-all">Registrati</button>
                    </div>
                </div>

                <div class="relative my-6 text-center">
                    <span class="bg-transparent px-2 text-[10px] text-slate-500 font-bold uppercase tracking-widest">O Continua Con</span>
                </div>

                <button onclick="loginGoogle()" class="w-full bg-white text-black font-black py-4 rounded-2xl flex items-center justify-center gap-3 hover:bg-slate-200 transition-all uppercase text-xs">
                    <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-5">
                    Google Auth
                </button>
            </div>

            <div id="user-ui" class="hidden text-center">
                <div class="flex flex-col items-center">
                    <div class="relative mb-6">
                        <img id="user-img" src="" class="w-32 h-32 rounded-full border-4 border-slate-800 object-cover bg-slate-900 shadow-2xl">
                        <div id="verify-badge" class="absolute -top-2 -right-2 bg-yellow-500 text-black text-[8px] font-black px-2 py-1 rounded hidden">NON VERIFICATO</div>
                    </div>
                    <h3 id="user-name" class="text-3xl font-black font-[Orbitron] uppercase italic tracking-tighter">OPERATORE</h3>
                    <p id="user-email" class="text-slate-400 text-[10px] mt-1 mb-8 italic font-bold"></p>
                    <button onclick="logout()" class="text-[9px] font-black uppercase tracking-[0.5em] text-red-500 hover:text-red-400">Termina Sessione</button>
                </div>
            </div>
        </div>

        <div id="modules-ui" class="flex flex-col gap-4 opacity-30 pointer-events-none transition-all duration-500">
            <a href="database.html" class="glass-card p-8 rounded-[2.5rem] group relative overflow-hidden">
                <h3 class="text-2xl font-black italic uppercase tracking-tighter group-hover:text-red-500">Archivio</h3>
                <p class="text-slate-400 text-[10px] font-bold uppercase mt-1">Sincronizzazione Richiesta...</p>
            </a>
            </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { 
            getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut, 
            signInWithEmailAndPassword, createUserWithEmailAndPassword, sendEmailVerification 
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyA7Xb8BbyL9s7buH_BW0hx2exD5Tb5G-pk",
            authDomain: "pokerole-app.firebaseapp.com",
            projectId: "pokerole-app",
            storageBucket: "pokerole-app.firebasestorage.app",
            messagingSenderId: "385416519668",
            appId: "1:385416519668:web:908e12b9833f1cdc04a3a1"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        // --- REGISTRAZIONE CON INVIO EMAIL DI CONFERMA ---
        window.registerWithVerification = async () => {
            const e = document.getElementById('email').value;
            const p = document.getElementById('password').value;

            if (p.length < 6) {
                alert("ERRORE: La password deve avere almeno 6 caratteri.");
                return;
            }

            try {
                const cred = await createUserWithEmailAndPassword(auth, e, p);
                
                // Invia l'email di verifica
                await sendEmailVerification(cred.user);
                
                // Crea il profilo nel database
                await setDoc(doc(db, "Users", cred.user.uid), {
                    email: e,
                    verified: false,
                    allenatori_generati: [],
                    pokemon_salvati: []
                });

                alert("PROTOCOLLO AVVIATO: Ti abbiamo inviato un'email di conferma. Clicca sul link nella mail per attivare il tuo ProDex.");
                
            } catch (err) {
                alert("ERRORE DI SISTEMA: " + err.message);
            }
        };

        window.loginEmail = () => {
            const e = document.getElementById('email').value;
            const p = document.getElementById('password').value;
            signInWithEmailAndPassword(auth, e, p).catch(err => alert("ACCESSO NEGATO: Credenziali errate."));
        };

        window.loginGoogle = () => signInWithPopup(auth, provider);
        window.logout = () => signOut(auth);

        onAuthStateChanged(auth, (user) => {
            const authUI = document.getElementById('auth-ui');
            const userUI = document.getElementById('user-ui');
            const modulesUI = document.getElementById('modules-ui');
            const badge = document.getElementById('verify-badge');

            if (user) {
                authUI.classList.add('hidden');
                userUI.classList.remove('hidden');
                modulesUI.classList.remove('opacity-30', 'pointer-events-none');
                
                document.getElementById('user-name').innerText = (user.displayName || user.email.split('@')[0]).toUpperCase();
                document.getElementById('user-email').innerText = user.email;
                document.getElementById('user-img').src = user.photoURL || `https://api.dicebear.com/7.x/bottts/svg?seed=${user.uid}`;

                // Controllo se l'email è stata verificata
                if (!user.emailVerified) {
                    badge.classList.remove('hidden');
                    console.log("Email non ancora verificata.");
                } else {
                    badge.classList.add('hidden');
                }

                // Genera dinamicamente i tasti loggati
                modulesUI.innerHTML = `
                    <a href="database.html" class="glass-card p-6 rounded-[2rem] group relative overflow-hidden">
                        <h3 class="text-xl font-black italic uppercase tracking-tighter group-hover:text-red-500">Archivio</h3>
                        <p class="text-slate-400 text-[9px] font-bold uppercase">Data-Bank Pokémon</p>
                    </a>
                    <a href="allenatore.html" class="glass-card p-6 rounded-[2rem] group relative overflow-hidden border-yellow-500/20 bg-yellow-500/5">
                        <h3 class="text-xl font-black italic uppercase tracking-tighter group-hover:text-yellow-500">Allenatore</h3>
                        <p class="text-slate-400 text-[9px] font-bold uppercase">Gestione Personale</p>
                    </a>
                    <a href="pokemon.html" class="glass-card p-6 rounded-[2rem] group relative overflow-hidden border-blue-500/20 bg-blue-500/5">
                        <h3 class="text-xl font-black italic uppercase tracking-tighter group-hover:text-blue-400">I Miei Pokémon</h3>
                        <p class="text-slate-400 text-[9px] font-bold uppercase">Cloud Storage Unità</p>
                    </a>
                `;
            } else {
                authUI.classList.remove('hidden');
                userUI.classList.add('hidden');
                modulesUI.classList.add('opacity-30', 'pointer-events-none');
                modulesUI.innerHTML = `<div class="p-10 text-center text-slate-600 font-bold uppercase text-[10px] italic">Eseguire il login per accedere ai moduli</div>`;
            }
        });
    </script>
</body>
</html>
